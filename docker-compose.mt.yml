# Multi-tenant (db-per-tenant-org) overlay for docker-compose.yml
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.mt.yml up -d --build
#
# This overlay:
# - switches API/worker to db-per-tenant-org mode
# - uses Postgres DATABASE_URL_TEMPLATE for tenant/org isolation
# - bootstraps tenant/org databases once via mt-bootstrap

services:
  api:
    environment:
      YUANTUS_TENANCY_MODE: db-per-tenant-org
      YUANTUS_ENVIRONMENT: dev
      YUANTUS_SCHEMA_MODE: create_all
      YUANTUS_DATABASE_URL: postgresql+psycopg://yuantus:yuantus@postgres:5432/yuantus
      YUANTUS_DATABASE_URL_TEMPLATE: postgresql+psycopg://yuantus:yuantus@postgres:5432/yuantus_mt_pg__{tenant_id}__{org_id}
      YUANTUS_IDENTITY_DATABASE_URL: postgresql+psycopg://yuantus:yuantus@postgres:5432/yuantus_identity_mt_pg
      YUANTUS_STORAGE_TYPE: s3
      YUANTUS_S3_ENDPOINT_URL: http://minio:9000
      YUANTUS_S3_PUBLIC_ENDPOINT_URL: http://localhost:59000
      YUANTUS_S3_BUCKET_NAME: yuantus
      YUANTUS_S3_ACCESS_KEY_ID: minioadmin
      YUANTUS_S3_SECRET_ACCESS_KEY: minioadmin
    depends_on:
      postgres:
        condition: service_healthy
      mt-bootstrap:
        condition: service_completed_successfully

  worker:
    environment:
      YUANTUS_TENANCY_MODE: db-per-tenant-org
      YUANTUS_ENVIRONMENT: dev
      YUANTUS_SCHEMA_MODE: create_all
      YUANTUS_DATABASE_URL: postgresql+psycopg://yuantus:yuantus@postgres:5432/yuantus
      YUANTUS_DATABASE_URL_TEMPLATE: postgresql+psycopg://yuantus:yuantus@postgres:5432/yuantus_mt_pg__{tenant_id}__{org_id}
      YUANTUS_IDENTITY_DATABASE_URL: postgresql+psycopg://yuantus:yuantus@postgres:5432/yuantus_identity_mt_pg
      YUANTUS_STORAGE_TYPE: s3
      YUANTUS_S3_ENDPOINT_URL: http://minio:9000
      YUANTUS_S3_PUBLIC_ENDPOINT_URL: http://localhost:59000
      YUANTUS_S3_BUCKET_NAME: yuantus
      YUANTUS_S3_ACCESS_KEY_ID: minioadmin
      YUANTUS_S3_SECRET_ACCESS_KEY: minioadmin
    depends_on:
      - api

  mt-bootstrap:
    image: postgres:16-alpine
    restart: "no"
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PGPASSWORD: yuantus
      TENANTS: tenant-1,tenant-2
      ORGS: org-1,org-2
      DB_PREFIX: yuantus_mt_pg__
      IDENTITY_DB: yuantus_identity_mt_pg
    command:
      - sh
      - -c
      - |
          set -eu
          create_db() {
            db="$$1"
            exists="$$(psql -h postgres -U yuantus -d postgres -tAc "SELECT 1 FROM pg_database WHERE datname='$$db'" | tr -d '[:space:]')"
            if [ "$$exists" != "1" ]; then
              echo "Creating database: $$db"
              createdb -h postgres -U yuantus "$$db"
            else
              echo "Database exists: $$db"
            fi
          }
          create_db "$$IDENTITY_DB"
          for tenant in $$(echo "$$TENANTS" | tr "," " "); do
            for org in $$(echo "$$ORGS" | tr "," " "); do
              create_db "$$DB_PREFIX$${tenant}__$${org}"
            done
          done
          echo "mt-bootstrap complete."
