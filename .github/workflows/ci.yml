name: CI

on:
  pull_request:
  workflow_dispatch: {}
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect_changes_ci:
    name: detect_changes (CI)
    runs-on: ubuntu-latest
    outputs:
      run_plugin_tests: ${{ steps.change_flags.outputs.run_plugin_tests }}
      run_playwright: ${{ steps.change_flags.outputs.run_playwright }}
      run_contracts: ${{ steps.change_flags.outputs.run_contracts }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect change scope
        id: change_flags
        run: |
          set -euo pipefail
          event="${{ github.event_name }}"

          # On main pushes, keep CI fully enabled.
          if [[ "${event}" != "pull_request" ]]; then
            run_plugin_tests="true"
            run_playwright="true"
            run_contracts="true"
            echo "run_plugin_tests=true" >> "$GITHUB_OUTPUT"
            echo "run_playwright=true" >> "$GITHUB_OUTPUT"
            echo "run_contracts=true" >> "$GITHUB_OUTPUT"

            {
              echo "## CI Change Scope"
              echo ""
              echo "- event: \`${event}\`"
              echo "- reason: \`non-pull_request => full CI\`"
              echo "- run_plugin_tests: \`${run_plugin_tests}\`"
              echo "- run_playwright: \`${run_playwright}\`"
              echo "- run_contracts: \`${run_contracts}\`"
            } >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          # Optional override: if the PR has label `ci:full`, force all CI jobs.
          labels_json='${{ toJson(github.event.pull_request.labels.*.name) }}'
          force_full="false"
          if [[ -n "${labels_json}" && "${labels_json}" != "null" ]]; then
            if echo "${labels_json}" | grep -q '"ci:full"'; then
              force_full="true"
            fi
          fi

          base="${{ github.event.pull_request.base.sha }}"
          head="${{ github.event.pull_request.head.sha }}"
          if [[ -z "${base}" || -z "${head}" ]]; then
            run_plugin_tests="true"
            run_playwright="true"
            run_contracts="true"
            echo "run_plugin_tests=true" >> "$GITHUB_OUTPUT"
            echo "run_playwright=true" >> "$GITHUB_OUTPUT"
            echo "run_contracts=true" >> "$GITHUB_OUTPUT"

            {
              echo "## CI Change Scope"
              echo ""
              echo "- force_full (label ci:full): \`${force_full}\`"
              echo "- reason: \`missing base/head sha => full CI\`"
              echo "- run_plugin_tests: \`${run_plugin_tests}\`"
              echo "- run_playwright: \`${run_playwright}\`"
              echo "- run_contracts: \`${run_contracts}\`"
            } >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          git diff --name-only "${base}" "${head}" > /tmp/changed.txt
          changed_count="$(wc -l < /tmp/changed.txt | tr -d ' ')"

          run_plugin_tests="false"
          run_playwright="false"
          run_contracts="false"
          reason_plugin_tests=""
          reason_playwright=""
          reason_contracts=""

          while IFS= read -r f; do
            [[ -z "${f}" ]] && continue

            case "${f}" in
              .github/workflows/ci.yml|pyproject.toml|requirements.lock|alembic.ini)
                run_plugin_tests="true"
                run_playwright="true"
                run_contracts="true"
                reason_plugin_tests="${reason_plugin_tests:-matched core inputs: ${f}}"
                reason_playwright="${reason_playwright:-matched core inputs: ${f}}"
                reason_contracts="${reason_contracts:-matched core inputs: ${f}}"
                break
                ;;
              .github/workflows/*.yml|.github/workflows/*.yaml|configs/perf_gate.json)
                run_contracts="true"
                reason_contracts="${reason_contracts:-matched workflow/perf config: ${f}}"
                ;;
              scripts/perf_*.py|scripts/perf_*.sh)
                run_contracts="true"
                reason_contracts="${reason_contracts:-matched perf script: ${f}}"
                ;;
              scripts/*.sh|scripts/*.py)
                run_contracts="true"
                reason_contracts="${reason_contracts:-matched scripts: ${f}}"
                ;;
              docs/DELIVERY_DOC_INDEX.md)
                run_contracts="true"
                reason_contracts="${reason_contracts:-matched delivery doc index: ${f}}"
                ;;
              README.md|docs/RUNBOOK_*.md|docs/OPS_RUNBOOK_MT.md|docs/ERROR_CODES*.md)
                run_contracts="true"
                reason_contracts="${reason_contracts:-matched docs wiring: ${f}}"
                ;;
              migrations/*)
                run_plugin_tests="true"
                reason_plugin_tests="${reason_plugin_tests:-matched migration: ${f}}"
                break
                ;;
              package.json|package-lock.json|playwright/*)
                run_playwright="true"
                reason_playwright="${reason_playwright:-matched frontend/playwright: ${f}}"
                ;;
              src/*)
                # Ignore test-only changes for the heavier CI jobs.
                if [[ "${f}" == *"/tests/"* ]]; then
                  continue
                fi
                base_name="$(basename "${f}")"
                if [[ "${base_name}" == test_*.py ]]; then
                  continue
                fi
                run_plugin_tests="true"
                run_playwright="true"
                reason_plugin_tests="${reason_plugin_tests:-matched src: ${f}}"
                reason_playwright="${reason_playwright:-matched src: ${f}}"
                ;;
            esac
          done < /tmp/changed.txt

          if [[ "${force_full}" == "true" ]]; then
            run_plugin_tests="true"
            run_playwright="true"
            run_contracts="true"
            reason_plugin_tests="forced by label ci:full"
            reason_playwright="forced by label ci:full"
            reason_contracts="forced by label ci:full"
          fi

          echo "run_plugin_tests=${run_plugin_tests}" >> "$GITHUB_OUTPUT"
          echo "run_playwright=${run_playwright}" >> "$GITHUB_OUTPUT"
          echo "run_contracts=${run_contracts}" >> "$GITHUB_OUTPUT"

          {
            echo "## CI Change Scope"
            echo ""
            echo "- force_full (label ci:full): \`${force_full}\`"
            echo "- run_plugin_tests: \`${run_plugin_tests}\`"
            echo "- run_plugin_tests_reason: \`${reason_plugin_tests}\`"
            echo "- run_playwright: \`${run_playwright}\`"
            echo "- run_playwright_reason: \`${reason_playwright}\`"
            echo "- run_contracts: \`${run_contracts}\`"
            echo "- run_contracts_reason: \`${reason_contracts}\`"
            echo ""
            echo "Changed files: ${changed_count}"
            echo ""
            echo "### Changed Files (first 50)"
            echo ""
            echo '```text'
            head -n 50 /tmp/changed.txt
            if [[ "${changed_count}" -gt 50 ]]; then
              echo "... (truncated; see logs for full list)"
            fi
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

  contracts:
    needs: detect_changes_ci
    if: needs.detect_changes_ci.outputs.run_contracts == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: "pip"
          cache-dependency-path: |
            requirements.lock
      - name: Install pytest
        run: |
          python -m pip install --upgrade pip
          python -m pip install pytest pyyaml
      - name: Validate workflow YAML
        run: |
          python - <<'PY'
          from __future__ import annotations
          
          from pathlib import Path
          
          import yaml
          
          workflows = sorted(Path(".github/workflows").glob("*.y*ml"))
          assert workflows, "No workflow YAML files found under .github/workflows"
          
          for wf in workflows:
            yaml.safe_load(wf.read_text(encoding="utf-8", errors="replace"))
          
          print(f"workflow_yaml_ok={len(workflows)}")
          PY
      - name: Contract checks (perf workflows + delivery doc index)
        run: |
          pytest -q \
            src/yuantus/meta_engine/tests/test_perf_workflow_contracts.py \
            src/yuantus/meta_engine/tests/test_workflow_concurrency_contracts.py \
            src/yuantus/meta_engine/tests/test_workflow_label_override_contracts.py \
            src/yuantus/meta_engine/tests/test_ci_shell_scripts_syntax.py \
            src/yuantus/meta_engine/tests/test_ci_change_scope_contracts.py \
            src/yuantus/meta_engine/tests/test_perf_gate_config_file.py \
            src/yuantus/meta_engine/tests/test_perf_ci_baseline_downloader_script.py \
            src/yuantus/meta_engine/tests/test_readme_runbook_references.py \
            src/yuantus/meta_engine/tests/test_runbook_index_completeness.py \
            src/yuantus/meta_engine/tests/test_delivery_doc_index_references.py

  plugin-tests:
    needs: detect_changes_ci
    if: needs.detect_changes_ci.outputs.run_plugin_tests == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: "pip"
          cache-dependency-path: |
            requirements.lock
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.lock
          pip install pytest
      - name: Migrations smoke
        env:
          YUANTUS_DATABASE_URL: sqlite:///./ci.db
        run: |
          python -m alembic -c alembic.ini upgrade head
      - name: Plugin tests
        run: |
          pytest -q src/yuantus/meta_engine/tests/test_plugin_pack_and_go.py \
            src/yuantus/meta_engine/tests/test_plugin_bom_compare.py

  playwright-esign:
    needs: detect_changes_ci
    if: needs.detect_changes_ci.outputs.run_playwright == 'true'
    runs-on: ubuntu-latest
    env:
      PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: "1"
      BASE_URL: "http://127.0.0.1:7910"
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            pyproject.toml
      - name: Install Python dependencies
        run: |
          python -m venv .venv
          . .venv/bin/activate
          python -m pip install --upgrade pip
          python -m pip install -e .
      - name: Install Node dependencies
        run: npm ci
      - name: Playwright e-sign smoke
        run: npx playwright test
