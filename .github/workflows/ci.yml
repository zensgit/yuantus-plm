name: CI

on:
  pull_request:
  workflow_dispatch: {}
  push:
    branches:
      - main

permissions:
  contents: read
  actions: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect_changes_ci:
    name: detect_changes (CI)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      run_plugin_tests: ${{ steps.change_flags.outputs.run_plugin_tests }}
      run_playwright: ${{ steps.change_flags.outputs.run_playwright }}
      run_contracts: ${{ steps.change_flags.outputs.run_contracts }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect change scope
        id: change_flags
        run: |
          set -euo pipefail
          event="${{ github.event_name }}"

          # On main pushes, keep CI fully enabled.
          if [[ "${event}" != "pull_request" ]]; then
            run_plugin_tests="true"
            run_playwright="true"
            run_contracts="true"
            echo "run_plugin_tests=true" >> "$GITHUB_OUTPUT"
            echo "run_playwright=true" >> "$GITHUB_OUTPUT"
            echo "run_contracts=true" >> "$GITHUB_OUTPUT"

            {
              echo "## CI Change Scope"
              echo ""
              echo "- event: \`${event}\`"
              echo "- reason: \`non-pull_request => full CI\`"
              echo "- run_plugin_tests: \`${run_plugin_tests}\`"
              echo "- run_playwright: \`${run_playwright}\`"
              echo "- run_contracts: \`${run_contracts}\`"
            } >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          # Optional override: if the PR has label `ci:full`, force all CI jobs.
          labels_json='${{ toJson(github.event.pull_request.labels.*.name) }}'
          force_full="false"
          if [[ -n "${labels_json}" && "${labels_json}" != "null" ]]; then
            if echo "${labels_json}" | grep -q '"ci:full"'; then
              force_full="true"
            fi
          fi

          base="${{ github.event.pull_request.base.sha }}"
          head="${{ github.event.pull_request.head.sha }}"
          if [[ -z "${base}" || -z "${head}" ]]; then
            run_plugin_tests="true"
            run_playwright="true"
            run_contracts="true"
            echo "run_plugin_tests=true" >> "$GITHUB_OUTPUT"
            echo "run_playwright=true" >> "$GITHUB_OUTPUT"
            echo "run_contracts=true" >> "$GITHUB_OUTPUT"

            {
              echo "## CI Change Scope"
              echo ""
              echo "- force_full (label ci:full): \`${force_full}\`"
              echo "- reason: \`missing base/head sha => full CI\`"
              echo "- run_plugin_tests: \`${run_plugin_tests}\`"
              echo "- run_playwright: \`${run_playwright}\`"
              echo "- run_contracts: \`${run_contracts}\`"
            } >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          git diff --name-only "${base}" "${head}" > /tmp/changed.txt
          changed_count="$(wc -l < /tmp/changed.txt | tr -d ' ')"

          run_plugin_tests="false"
          run_playwright="false"
          run_contracts="false"
          reason_plugin_tests=""
          reason_playwright=""
          reason_contracts=""

          while IFS= read -r f; do
            [[ -z "${f}" ]] && continue

            case "${f}" in
              .github/workflows/ci.yml|pyproject.toml|requirements.lock|alembic.ini|alembic.identity.ini)
                run_plugin_tests="true"
                run_playwright="true"
                run_contracts="true"
                reason_plugin_tests="${reason_plugin_tests:-matched core inputs: ${f}}"
                reason_playwright="${reason_playwright:-matched core inputs: ${f}}"
                reason_contracts="${reason_contracts:-matched core inputs: ${f}}"
                break
                ;;
              .github/workflows/*.yml|.github/workflows/*.yaml|configs/perf_gate.json)
                run_contracts="true"
                reason_contracts="${reason_contracts:-matched workflow/perf config: ${f}}"
                ;;
              scripts/perf_*.py|scripts/perf_*.sh)
                run_contracts="true"
                reason_contracts="${reason_contracts:-matched perf script: ${f}}"
                ;;
              scripts/*.sh|scripts/*.py)
                run_contracts="true"
                reason_contracts="${reason_contracts:-matched scripts: ${f}}"
                ;;
              docs/DELIVERY_DOC_INDEX.md)
                run_contracts="true"
                reason_contracts="${reason_contracts:-matched delivery doc index: ${f}}"
                ;;
              README.md|docs/RUNBOOK_*.md|docs/OPS_RUNBOOK_MT.md|docs/ERROR_CODES*.md)
                run_contracts="true"
                reason_contracts="${reason_contracts:-matched docs wiring: ${f}}"
                ;;
              migrations/*|migrations_identity/*)
                run_plugin_tests="true"
                reason_plugin_tests="${reason_plugin_tests:-matched migration: ${f}}"
                break
                ;;
              package.json|package-lock.json|playwright/*)
                run_playwright="true"
                reason_playwright="${reason_playwright:-matched frontend/playwright: ${f}}"
                ;;
              src/*)
                # Ignore test-only changes for the heavier CI jobs.
                if [[ "${f}" == *"/tests/"* ]]; then
                  continue
                fi
                base_name="$(basename "${f}")"
                if [[ "${base_name}" == test_*.py ]]; then
                  continue
                fi
                run_plugin_tests="true"
                run_playwright="true"
                reason_plugin_tests="${reason_plugin_tests:-matched src: ${f}}"
                reason_playwright="${reason_playwright:-matched src: ${f}}"
                ;;
            esac
          done < /tmp/changed.txt

          if [[ "${force_full}" == "true" ]]; then
            run_plugin_tests="true"
            run_playwright="true"
            run_contracts="true"
            reason_plugin_tests="forced by label ci:full"
            reason_playwright="forced by label ci:full"
            reason_contracts="forced by label ci:full"
          fi

          echo "run_plugin_tests=${run_plugin_tests}" >> "$GITHUB_OUTPUT"
          echo "run_playwright=${run_playwright}" >> "$GITHUB_OUTPUT"
          echo "run_contracts=${run_contracts}" >> "$GITHUB_OUTPUT"

          {
            echo "## CI Change Scope"
            echo ""
            echo "- force_full (label ci:full): \`${force_full}\`"
            echo "- run_plugin_tests: \`${run_plugin_tests}\`"
            echo "- run_plugin_tests_reason: \`${reason_plugin_tests}\`"
            echo "- run_playwright: \`${run_playwright}\`"
            echo "- run_playwright_reason: \`${reason_playwright}\`"
            echo "- run_contracts: \`${run_contracts}\`"
            echo "- run_contracts_reason: \`${reason_contracts}\`"
            echo ""
            echo "Changed files: ${changed_count}"
            echo ""
            echo "### Changed Files (first 50)"
            echo ""
            echo '```text'
            head -n 50 /tmp/changed.txt
            if [[ "${changed_count}" -gt 50 ]]; then
              echo "... (truncated; see logs for full list)"
            fi
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

  contracts:
    name: contracts
    needs: detect_changes_ci
    if: needs.detect_changes_ci.outputs.run_contracts == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: "pip"
          cache-dependency-path: |
            requirements.lock
      - name: Install pytest
        run: |
          python -m pip install --upgrade pip
          python -m pip install pytest pyyaml
      - name: Validate workflow YAML
        run: |
          python - <<'PY'
          from __future__ import annotations
          
          from pathlib import Path
          
          import yaml
          
          workflows = sorted(Path(".github/workflows").glob("*.y*ml"))
          assert workflows, "No workflow YAML files found under .github/workflows"
          
          for wf in workflows:
            yaml.safe_load(wf.read_text(encoding="utf-8", errors="replace"))
          
          print(f"workflow_yaml_ok={len(workflows)}")
          PY
      - name: Contract checks (perf workflows + delivery doc index)
        run: |
          pytest -q \
            src/yuantus/meta_engine/tests/test_ci_change_scope_contracts.py \
            src/yuantus/meta_engine/tests/test_ci_contracts_cad_import_dedup_index.py \
            src/yuantus/meta_engine/tests/test_ci_contracts_ci_yml_test_list_order.py \
            src/yuantus/meta_engine/tests/test_ci_contracts_compose_worker_dedup_vision_url.py \
            src/yuantus/meta_engine/tests/test_ci_contracts_dedup_auto_trigger_workflow.py \
            src/yuantus/meta_engine/tests/test_ci_contracts_dedup_batch_run_index.py \
            src/yuantus/meta_engine/tests/test_ci_contracts_dedup_job_promotion.py \
            src/yuantus/meta_engine/tests/test_ci_contracts_dedup_report_endpoints.py \
            src/yuantus/meta_engine/tests/test_ci_contracts_dedup_similarity_pair_key.py \
            src/yuantus/meta_engine/tests/test_ci_contracts_dedup_vision_host_fallback.py \
            src/yuantus/meta_engine/tests/test_ci_contracts_dedup_vision_v2_fallback.py \
            src/yuantus/meta_engine/tests/test_ci_contracts_dedup_vision_verify_script_docker_worker.py \
            src/yuantus/meta_engine/tests/test_ci_contracts_dedup_vision_verify_scripts_port_override.py \
            src/yuantus/meta_engine/tests/test_ci_contracts_doc_index_sorting.py \
            src/yuantus/meta_engine/tests/test_ci_contracts_http_code_normalization_cad_scripts.py \
            src/yuantus/meta_engine/tests/test_ci_contracts_job_wiring.py \
            src/yuantus/meta_engine/tests/test_ci_contracts_no_inline_echo_000_in_scripts.py \
            src/yuantus/meta_engine/tests/test_ci_contracts_playwright_esign_retry.py \
            src/yuantus/meta_engine/tests/test_ci_contracts_strict_gate_report_perf_smokes.py \
            src/yuantus/meta_engine/tests/test_ci_contracts_verify_all_dedup_config_order.py \
            src/yuantus/meta_engine/tests/test_ci_contracts_verify_all_env_allowlist.py \
            src/yuantus/meta_engine/tests/test_ci_contracts_verify_all_health_http_code.py \
            src/yuantus/meta_engine/tests/test_ci_contracts_verify_all_is_truthy_order.py \
            src/yuantus/meta_engine/tests/test_ci_contracts_verify_all_mt_skip_db_placeholder.py \
            src/yuantus/meta_engine/tests/test_ci_contracts_verify_all_perf_smokes.py \
            src/yuantus/meta_engine/tests/test_ci_contracts_verify_all_stack_reuse_on_start_conflict.py \
            src/yuantus/meta_engine/tests/test_ci_contracts_verify_mbom_convert_db_url_fallback.py \
            src/yuantus/meta_engine/tests/test_ci_contracts_version_file_binding_viewer_uniqueness.py \
            src/yuantus/meta_engine/tests/test_ci_shell_scripts_syntax.py \
            src/yuantus/meta_engine/tests/test_db_cli_identity_contracts.py \
            src/yuantus/meta_engine/tests/test_delivery_doc_index_all_sections_sorting_contracts.py \
            src/yuantus/meta_engine/tests/test_delivery_doc_index_core_ops_sorting_contracts.py \
            src/yuantus/meta_engine/tests/test_delivery_doc_index_core_required_entries_contracts.py \
            src/yuantus/meta_engine/tests/test_delivery_doc_index_external_sorting_contracts.py \
            src/yuantus/meta_engine/tests/test_delivery_doc_index_ops_required_entries_contracts.py \
            src/yuantus/meta_engine/tests/test_delivery_doc_index_product_optional_sorting_contracts.py \
            src/yuantus/meta_engine/tests/test_delivery_doc_index_references.py \
            src/yuantus/meta_engine/tests/test_delivery_doc_index_section_headings_contracts.py \
            src/yuantus/meta_engine/tests/test_delivery_doc_index_verification_reports_sorting_contracts.py \
            src/yuantus/meta_engine/tests/test_dev_and_verification_doc_index_completeness.py \
            src/yuantus/meta_engine/tests/test_dev_and_verification_doc_index_sorting_contracts.py \
            src/yuantus/meta_engine/tests/test_job_queue_tx_boundary_contracts.py \
            src/yuantus/meta_engine/tests/test_migration_table_coverage_contracts.py \
            src/yuantus/meta_engine/tests/test_perf_ci_baseline_downloader_script.py \
            src/yuantus/meta_engine/tests/test_perf_gate_config_file.py \
            src/yuantus/meta_engine/tests/test_perf_workflow_contracts.py \
            src/yuantus/meta_engine/tests/test_readme_runbook_references.py \
            src/yuantus/meta_engine/tests/test_readme_runbooks_are_indexed_in_delivery_doc_index.py \
            src/yuantus/meta_engine/tests/test_readme_runbooks_sorting_contracts.py \
            src/yuantus/meta_engine/tests/test_runbook_index_completeness.py \
            src/yuantus/meta_engine/tests/test_strict_gate_recent_perf_audit_regression_script_behavior_contracts.py \
            src/yuantus/meta_engine/tests/test_strict_gate_recent_perf_audit_regression_script_contracts.py \
            src/yuantus/meta_engine/tests/test_strict_gate_recent_perf_regression_workflow_contracts.py \
            src/yuantus/meta_engine/tests/test_strict_gate_workflow_contracts.py \
            src/yuantus/meta_engine/tests/test_strict_gate_workflow_dispatch_input_type_contracts.py \
            src/yuantus/meta_engine/tests/test_workflow_action_uses_refs_contracts.py \
            src/yuantus/meta_engine/tests/test_workflow_concurrency_all_contracts.py \
            src/yuantus/meta_engine/tests/test_workflow_concurrency_contracts.py \
            src/yuantus/meta_engine/tests/test_workflow_dispatch_inputs_contracts.py \
            src/yuantus/meta_engine/tests/test_workflow_dispatch_inputs_metadata_contracts.py \
            src/yuantus/meta_engine/tests/test_workflow_inline_shell_syntax_contracts.py \
            src/yuantus/meta_engine/tests/test_workflow_job_name_contracts.py \
            src/yuantus/meta_engine/tests/test_workflow_job_timeout_contracts.py \
            src/yuantus/meta_engine/tests/test_workflow_label_override_contracts.py \
            src/yuantus/meta_engine/tests/test_workflow_name_uniqueness_contracts.py \
            src/yuantus/meta_engine/tests/test_workflow_needs_integrity_contracts.py \
            src/yuantus/meta_engine/tests/test_workflow_no_job_level_permissions_contracts.py \
            src/yuantus/meta_engine/tests/test_workflow_permissions_contracts.py \
            src/yuantus/meta_engine/tests/test_workflow_permissions_least_privilege_contracts.py \
            src/yuantus/meta_engine/tests/test_workflow_permissions_scope_allowlist_contracts.py \
            src/yuantus/meta_engine/tests/test_workflow_runner_policy_contracts.py \
            src/yuantus/meta_engine/tests/test_workflow_schedule_cron_contracts.py \
            src/yuantus/meta_engine/tests/test_workflow_script_reference_contracts.py \
            src/yuantus/meta_engine/tests/test_workflow_trigger_paths_contracts.py \
            src/yuantus/meta_engine/tests/test_workflow_upload_artifact_name_contracts.py \
            src/yuantus/meta_engine/tests/test_workflow_upload_artifact_retention_contracts.py \
            src/yuantus/meta_engine/tests/test_workflow_yaml_parseability_contracts.py

  plugin-tests:
    name: plugin-tests
    needs: detect_changes_ci
    if: needs.detect_changes_ci.outputs.run_plugin_tests == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: "pip"
          cache-dependency-path: |
            requirements.lock
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.lock
          pip install pytest
      - name: Migrations smoke
        env:
          YUANTUS_DATABASE_URL: sqlite:///./ci.db
        run: |
          python -m alembic -c alembic.ini upgrade head
      - name: Identity-only migrations smoke
        env:
          YUANTUS_DATABASE_URL: sqlite:///./ci_identity.db
        run: |
          python -m alembic -c alembic.identity.ini upgrade head
      - name: Plugin tests
        run: |
          pytest -q src/yuantus/meta_engine/tests/test_plugin_pack_and_go.py \
            src/yuantus/meta_engine/tests/test_plugin_bom_compare.py

  playwright-esign:
    name: playwright-esign
    needs: detect_changes_ci
    if: needs.detect_changes_ci.outputs.run_playwright == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: "1"
      BASE_URL: "http://127.0.0.1:7910"
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            pyproject.toml
      - name: Install Python dependencies
        run: |
          python -m venv .venv
          . .venv/bin/activate
          python -m pip install --upgrade pip
          python -m pip install -e .
      - name: Install Node dependencies
        run: npm ci
      - name: Playwright e-sign smoke
        run: |
          set -euo pipefail
          attempts=2
          retry_delay_sec=5
          for attempt in $(seq 1 "${attempts}"); do
            echo "Playwright e-sign smoke attempt ${attempt}/${attempts}"
            if npx playwright test; then
              exit 0
            fi
            if [[ "${attempt}" -lt "${attempts}" ]]; then
              echo "Playwright e-sign smoke failed on attempt ${attempt}; retry in ${retry_delay_sec}s..."
              sleep "${retry_delay_sec}"
            fi
          done
          echo "ERROR: Playwright e-sign smoke failed after ${attempts} attempts" >&2
          exit 1
