name: regression

on:
  workflow_dispatch:
    inputs:
      run_cad_ml:
        description: "Start cad-ml docker for regression"
        required: false
        default: "false"
  schedule:
    - cron: "0 2 * * *"
  push:
    branches:
      - main
      - master
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect_changes_regression:
    name: detect_changes (regression)
    runs-on: ubuntu-latest
    outputs:
      cadgf_changed: ${{ steps.change_flags.outputs.cadgf }}
      regression_needed: ${{ steps.change_flags.outputs.regression }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect regression/CADGF-related changes
        id: change_flags
        run: |
          set -euo pipefail
          event="${{ github.event_name }}"
          if [[ "$event" == "schedule" || "$event" == "workflow_dispatch" ]]; then
            echo "cadgf=true" >> "$GITHUB_OUTPUT"
            echo "regression=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Optional override labels (PR only):
          # - `ci:full` forces both `cadgf=true` and `regression=true`
          # - `cadgf:force` forces `cadgf=true`
          # - `regression:force` forces `regression=true`
          force_cadgf="false"
          force_regression="false"
          if [[ "$event" == "pull_request" ]]; then
            labels_json='${{ toJson(github.event.pull_request.labels.*.name) }}'
            if [[ -n "${labels_json}" && "${labels_json}" != "null" ]]; then
              if echo "${labels_json}" | grep -q '"ci:full"'; then
                force_regression="true"
                force_cadgf="true"
              fi
              if echo "${labels_json}" | grep -q '"regression:force"'; then
                force_regression="true"
              fi
              if echo "${labels_json}" | grep -q '"cadgf:force"'; then
                force_cadgf="true"
              fi
            fi
          fi

          base=""
          head=""
          if [[ "$event" == "pull_request" ]]; then
            base="${{ github.event.pull_request.base.sha }}"
            head="${{ github.event.pull_request.head.sha }}"
          elif [[ "$event" == "push" ]]; then
            base="${{ github.event.before }}"
            head="${{ github.sha }}"
          fi

          if [[ -z "$base" || -z "$head" ]]; then
            echo "cadgf=false" >> "$GITHUB_OUTPUT"
            echo "regression=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          git diff --name-only "$base" "$head" > /tmp/changed.txt
          changed_count="$(wc -l < /tmp/changed.txt | tr -d ' ')"
          cadgf="false"
          if grep -E -q '^(\\.github/workflows/regression\\.yml|docker-compose\\.cadgf\\.yml|docs/samples/cadgf_preview_square\\.dxf|docs/CADGF_|scripts/verify_cad_preview_online\\.sh|scripts/verify_all\\.sh|src/yuantus/config/settings\\.py|src/yuantus/meta_engine/services/cadgf_converter_service\\.py|src/yuantus/meta_engine/tasks/cad_pipeline_tasks\\.py)' /tmp/changed.txt; then
            cadgf="true"
          fi

          # Only run the full docker-compose regression on PR/push when the change set
          # can affect runtime/integration behavior. This avoids burning CI minutes
          # on docs-only or CI-only changes (perf workflow edits, etc.).
          regression="false"
          while IFS= read -r f; do
            [[ -z "${f}" ]] && continue
            case "${f}" in
              .github/workflows/regression.yml|alembic.ini|pyproject.toml|requirements.lock)
                regression="true"; break ;;
              docker-compose*.yml|Dockerfile*)
                regression="true"; break ;;
              migrations/*)
                regression="true"; break ;;
              scripts/verify_all.sh|scripts/verify_*.sh)
                regression="true"; break ;;
              docs/samples/*)
                regression="true"; break ;;
              src/*)
                # Ignore test-only changes for the expensive integration regression.
                if [[ "${f}" == *"/tests/"* ]]; then
                  continue
                fi
                base="$(basename "${f}")"
                if [[ "${base}" == test_*.py ]]; then
                  continue
                fi
                regression="true"; break ;;
            esac
          done < /tmp/changed.txt

          if [[ "${force_cadgf}" == "true" ]]; then
            cadgf="true"
          fi
          if [[ "${force_regression}" == "true" ]]; then
            regression="true"
          fi

          echo "cadgf=${cadgf}" >> "$GITHUB_OUTPUT"
          echo "regression=${regression}" >> "$GITHUB_OUTPUT"

          {
            echo "## Regression Change Scope"
            echo ""
            echo "- force_cadgf (labels ci:full/cadgf:force): \`${force_cadgf}\`"
            echo "- force_regression (labels ci:full/regression:force): \`${force_regression}\`"
            echo "- cadgf_changed: \`${cadgf}\`"
            echo "- regression_needed: \`${regression}\`"
            echo ""
            echo "Changed files: ${changed_count}"
            echo ""
            echo "### Changed Files (first 50)"
            echo ""
            echo '```text'
            head -n 50 /tmp/changed.txt
            if [[ "${changed_count}" -gt 50 ]]; then
              echo "... (truncated; see logs for full list)"
            fi
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

  regression:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: detect_changes_regression
    if: needs.detect_changes_regression.outputs.regression_needed == 'true'
    env:
      YUANTUS_CADGF_DEFAULT_EMIT: "json,gltf,meta"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Configure cad-ml docker (optional)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.run_cad_ml == 'true'
        run: |
          {
            echo "RUN_CAD_ML_DOCKER=1"
            echo "CAD_ML_REPO=${{ github.workspace }}/cad-ml-platform"
            echo "CAD_ML_API_PORT=18000"
            echo "CAD_ML_API_METRICS_PORT=19090"
            echo "CAD_ML_REDIS_PORT=16379"
          } >> "$GITHUB_ENV"

      - name: Checkout cad-ml-platform (optional)
        if: env.RUN_CAD_ML_DOCKER == '1'
        uses: actions/checkout@v4
        with:
          repository: zensgit/cad-ml-platform
          path: cad-ml-platform

      - name: Install CLI
        run: |
          python -m venv .venv
          . .venv/bin/activate
          python -m pip install --upgrade pip
          python -m pip install -e .

      - name: Start services
        run: docker compose -p yuantusplm -f docker-compose.yml up -d --build

      - name: Wait for API
        run: |
          for i in {1..60}; do
            code="$(curl -s -o /dev/null -w '%{http_code}' http://127.0.0.1:7910/api/v1/health || true)"
            if [ "$code" = "200" ]; then
              echo "API healthy"
              exit 0
            fi
            sleep 2
          done
          echo "API not healthy"
          docker compose -p yuantusplm ps
          docker compose -p yuantusplm logs --tail=200 api
          exit 1

      - name: Run regression suite
        env:
          RUN_CAD_AUTO_PART: "1"
          RUN_CAD_EXTRACTOR_SERVICE: "1"
        run: |
          . .venv/bin/activate
          bash scripts/verify_all.sh http://127.0.0.1:7910 tenant-1 org-1 2>&1 | tee regression.log

      - name: Build regression summary
        if: always()
        run: |
          {
            echo "# Regression Summary"
            echo ""
            echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo ""
            echo '```text'
            if grep -q "ALL TESTS PASSED" regression.log; then
              grep -n "PASS:" -n regression.log | tail -n 1 | sed 's/^.*PASS:/PASS:/'
              echo "ALL TESTS PASSED"
            else
              grep -n "PASS:" -n regression.log | tail -n 1 | sed 's/^.*PASS:/PASS:/' || true
              echo "ALL TESTS FAILED"
            fi
            echo '```'
            if [[ -f /tmp/cadgf_preview_online_report.md ]]; then
              echo ""
              echo "CADGF Preview Online:"
              grep -E "^- (metadata_present|file_id|exit_code)" /tmp/cadgf_preview_online_report.md || true
            else
              echo ""
              echo "CADGF Preview Online: separate job"
            fi
          } > regression-summary.md

      - name: Write summary to job summary
        if: always()
        run: |
          if [[ -f regression-summary.md ]]; then
            cat regression-summary.md >> "$GITHUB_STEP_SUMMARY"
          else
            echo "regression-summary.md missing" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Compose logs (on failure)
        if: failure()
        run: |
          docker compose -p yuantusplm ps
          docker compose -p yuantusplm logs --tail=200

      - name: Capture compose logs
        if: always()
        run: |
          docker compose -p yuantusplm ps || true
          docker compose -p yuantusplm logs > compose.log 2>&1 || true

      - name: Upload regression log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: regression-log
          path: regression.log

      - name: Upload regression summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: regression-summary
          path: regression-summary.md

      - name: Upload compose log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: compose-log
          path: compose.log

  cad_ml_quick:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    env:
      CAD_PREVIEW_SAMPLE_FILE: docs/samples/cad_ml_preview_sample.dxf
      RUN_CAD_ML_DOCKER: "1"
      RUN_CAD_ML_METRICS: "1"
      CAD_ML_API_PORT: "18000"
      CAD_ML_API_METRICS_PORT: "19090"
      CAD_ML_REDIS_PORT: "16379"
      CAD_ML_REPO: ${{ github.workspace }}/cad-ml-platform
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Checkout cad-ml-platform
        uses: actions/checkout@v4
        with:
          repository: zensgit/cad-ml-platform
          path: cad-ml-platform

      - name: Install CLI
        run: |
          python -m venv .venv
          . .venv/bin/activate
          python -m pip install --upgrade pip
          python -m pip install -e .

      - name: Start services
        run: docker compose -p yuantusplm-quick -f docker-compose.yml up -d --build

      - name: Wait for API
        run: |
          for i in {1..60}; do
            code="$(curl -s -o /dev/null -w '%{http_code}' http://127.0.0.1:7910/api/v1/health || true)"
            if [ "$code" = "200" ]; then
              echo "API healthy"
              exit 0
            fi
            sleep 2
          done
          echo "API not healthy"
          docker compose -p yuantusplm-quick ps
          docker compose -p yuantusplm-quick logs --tail=200 api
          exit 1

      - name: Run CAD-ML quick regression
        run: |
          . .venv/bin/activate
          bash scripts/verify_cad_ml_quick.sh http://127.0.0.1:7910 tenant-1 org-1 2>&1 | tee cad-ml-quick.log

      - name: Capture compose logs
        if: always()
        run: |
          docker compose -p yuantusplm-quick ps || true
          docker compose -p yuantusplm-quick logs > compose-quick.log 2>&1 || true

      - name: Upload CAD-ML quick log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cad-ml-quick-log
          path: cad-ml-quick.log

      - name: Upload compose log (cad-ml quick)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: compose-quick-log
          path: compose-quick.log

  cadgf_preview:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: detect_changes_regression
    if: >
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      needs.detect_changes_regression.outputs.cadgf_changed == 'true'
    env:
      CADGF_HOST_ROOT: ${{ github.workspace }}/CADGameFusion
      YUANTUS_CADGF_ROOT: ${{ github.workspace }}/CADGameFusion
      YUANTUS_CADGF_CONVERT_SCRIPT: ${{ github.workspace }}/CADGameFusion/tools/plm_convert.py
      YUANTUS_CADGF_CONVERT_CLI: ${{ github.workspace }}/CADGameFusion/build_vcpkg/tools/convert_cli
      YUANTUS_CADGF_DXF_PLUGIN_PATH: ${{ github.workspace }}/CADGameFusion/build_vcpkg/plugins/libcadgf_dxf_importer_plugin.so
      YUANTUS_CADGF_DEFAULT_EMIT: "json,gltf,meta"
      VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"
      VCPKG_FEATURE_FLAGS: "binarycaching"
      CADGF_PREVIEW_SAMPLE_FILE: "docs/samples/cadgf_preview_square.dxf"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Checkout CADGameFusion
        uses: actions/checkout@v4
        with:
          repository: zensgit/CADGameFusion
          path: CADGameFusion

      - name: Build CADGameFusion (core + plugin)
        run: |
          cd CADGameFusion
          ./scripts/bootstrap_vcpkg.sh
          export VCPKG_ROOT="$PWD/vcpkg"
          export CC=gcc
          export CXX=g++
          cmake -S . -B build_vcpkg \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_EDITOR_QT=OFF \
            -DCMAKE_TOOLCHAIN_FILE="$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" \
            -DVCPKG_MANIFEST_MODE=ON
          cmake --build build_vcpkg --config Release --parallel

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install CLI
        run: |
          python -m venv .venv
          . .venv/bin/activate
          python -m pip install --upgrade pip
          python -m pip install -e .

      - name: Start services
        run: docker compose -p yuantusplm -f docker-compose.yml -f docker-compose.cadgf.yml up -d --build

      - name: Wait for API
        run: |
          for i in {1..60}; do
            code="$(curl -s -o /dev/null -w '%{http_code}' http://127.0.0.1:7910/api/v1/health || true)"
            if [ "$code" = "200" ]; then
              echo "API healthy"
              exit 0
            fi
            sleep 2
          done
          echo "API not healthy"
          docker compose -p yuantusplm ps
          docker compose -p yuantusplm logs --tail=200 api
          exit 1

      - name: Restart worker after migrations
        run: |
          docker compose -p yuantusplm exec -T api yuantus db upgrade
          docker compose -p yuantusplm exec -T worker yuantus db upgrade || true
          docker compose -p yuantusplm restart worker

      - name: Seed identity + meta
        env:
          YUANTUS_DATABASE_URL: postgresql+psycopg://yuantus:yuantus@localhost:55432/yuantus
          YUANTUS_SCHEMA_MODE: migrations
        run: |
          . .venv/bin/activate
          yuantus seed-identity --tenant tenant-1 --org org-1 --username admin --password admin --user-id 1 --roles admin --superuser
          yuantus seed-meta --tenant tenant-1 --org org-1 || yuantus seed-meta

      - name: Run CADGF preview online
        env:
          BASE_URL: http://127.0.0.1:7910
          TENANT: tenant-1
          ORG: org-1
          LOGIN_USERNAME: admin
          PASSWORD: admin
          SAMPLE_FILE: ${{ env.CADGF_PREVIEW_SAMPLE_FILE }}
          CADGF_SYNC_GEOMETRY: "1"
          YUANTUS_DATABASE_URL: postgresql+psycopg://yuantus:yuantus@localhost:55432/yuantus
          YUANTUS_SCHEMA_MODE: migrations
          YUANTUS_STORAGE_TYPE: s3
          YUANTUS_S3_ENDPOINT_URL: http://127.0.0.1:59000
          YUANTUS_S3_PUBLIC_ENDPOINT_URL: http://127.0.0.1:59000
          YUANTUS_S3_BUCKET_NAME: yuantus
          YUANTUS_S3_ACCESS_KEY_ID: minioadmin
          YUANTUS_S3_SECRET_ACCESS_KEY: minioadmin
          LD_LIBRARY_PATH: ${{ github.workspace }}/CADGameFusion/build_vcpkg/vcpkg_installed/x64-linux/lib:${{ github.workspace }}/CADGameFusion/build_vcpkg/vcpkg_installed/x64-linux/lib64:${{ env.LD_LIBRARY_PATH }}
          EXPECT_METADATA: "1"
        run: |
          . .venv/bin/activate
          bash scripts/verify_cad_preview_online.sh

      - name: Build CADGF preview summary
        if: always()
        run: |
          {
            echo "# CADGF Preview Summary"
            echo ""
            echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo ""
            if [[ -f /tmp/cadgf_preview_online_report.md ]]; then
              grep -E "^- (metadata_present|file_id|exit_code)" /tmp/cadgf_preview_online_report.md || true
            else
              echo "cadgf_preview_report: missing"
            fi
          } > cadgf-preview-summary.md

      - name: Write summary to job summary
        if: always()
        run: |
          if [[ -f cadgf-preview-summary.md ]]; then
            cat cadgf-preview-summary.md >> "$GITHUB_STEP_SUMMARY"
          else
            echo "cadgf-preview-summary.md missing" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload CADGF preview report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cadgf-preview-report
          path: /tmp/cadgf_preview_online_report.md
          if-no-files-found: warn

      - name: Upload CADGF preview summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cadgf-preview-summary
          path: cadgf-preview-summary.md

      - name: Capture compose logs
        if: always()
        run: |
          docker compose -p yuantusplm ps || true
          docker compose -p yuantusplm logs > compose.log 2>&1 || true
      - name: Upload compose log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cadgf-preview-compose-log
          path: compose.log
