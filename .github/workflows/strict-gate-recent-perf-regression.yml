name: strict-gate-recent-perf-regression

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref used for strict-gate dispatch and regression checks"
        type: string
        required: false
        default: "main"
      poll_interval_sec:
        description: "Polling interval in seconds while waiting strict-gate runs"
        type: string
        required: false
        default: "8"
      max_wait_sec:
        description: "Max wait time per strict-gate run in seconds"
        type: string
        required: false
        default: "1800"
      regression_attempts:
        description: "Retry attempts for regression script when transient failures occur"
        type: string
        required: false
        default: "2"
      regression_retry_delay_sec:
        description: "Retry backoff delay in seconds between regression attempts"
        type: string
        required: false
        default: "15"
  schedule:
    # Weekly Tue 05:00 UTC: regression health check for strict-gate recent perf audit path.
    - cron: "0 5 * * 2"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: write

jobs:
  recent_perf_regression:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    env:
      GH_TOKEN: ${{ github.token }}
      OUTPUT_ROOT: tmp/strict-gate-artifacts/recent-perf-regression/${{ github.run_id }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve target ref
        id: target_ref
        run: |
          set -euo pipefail
          TARGET_REF="${{ github.ref_name }}"
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TARGET_REF="${{ github.event.inputs.ref }}"
          fi
          if [[ -z "${TARGET_REF}" ]]; then
            echo "ERROR: target ref is empty" >&2
            exit 2
          fi
          echo "target_ref=${TARGET_REF}" >> "$GITHUB_OUTPUT"

      - name: Run strict-gate recent perf audit regression
        env:
          TARGET_REF: ${{ steps.target_ref.outputs.target_ref }}
        run: |
          set -euo pipefail
          poll_interval="${{ github.event.inputs.poll_interval_sec }}"
          max_wait="${{ github.event.inputs.max_wait_sec }}"
          if [[ -z "${poll_interval}" ]]; then
            poll_interval="8"
          fi
          if [[ -z "${max_wait}" ]]; then
            max_wait="1800"
          fi
          attempts="${{ github.event.inputs.regression_attempts }}"
          retry_delay_sec="${{ github.event.inputs.regression_retry_delay_sec }}"
          if [[ -z "${attempts}" ]]; then
            attempts="2"
          fi
          if [[ -z "${retry_delay_sec}" ]]; then
            retry_delay_sec="15"
          fi
          if ! [[ "${attempts}" =~ ^[0-9]+$ ]] || [[ "${attempts}" -lt 1 ]] || [[ "${attempts}" -gt 3 ]]; then
            echo "ERROR: regression_attempts must be an integer in [1,3] (got: ${attempts})" >&2
            exit 2
          fi
          if ! [[ "${retry_delay_sec}" =~ ^[0-9]+$ ]] || [[ "${retry_delay_sec}" -lt 0 ]]; then
            echo "ERROR: regression_retry_delay_sec must be a non-negative integer (got: ${retry_delay_sec})" >&2
            exit 2
          fi

          mkdir -p "${OUTPUT_ROOT}"
          {
            echo "run_id=${{ github.run_id }}"
            echo "target_ref=${TARGET_REF}"
            echo "attempts=${attempts}"
            echo "retry_delay_sec=${retry_delay_sec}"
            echo "poll_interval_sec=${poll_interval}"
            echo "max_wait_sec=${max_wait}"
          } > "${OUTPUT_ROOT}/REGRESSION_RUN_CONTEXT.txt"

          success=0
          for attempt in $(seq 1 "${attempts}"); do
            attempt_dir="${OUTPUT_ROOT}/attempt-${attempt}"
            mkdir -p "${attempt_dir}"
            echo "==> strict-gate recent perf regression attempt ${attempt}/${attempts}"
            if bash scripts/strict_gate_recent_perf_audit_regression.sh \
              --workflow strict-gate.yml \
              --repo "${{ github.repository }}" \
              --ref "${TARGET_REF}" \
              --poll-interval-sec "${poll_interval}" \
              --max-wait-sec "${max_wait}" \
              --out-dir "${attempt_dir}" \
              --summary-json "${attempt_dir}/STRICT_GATE_RECENT_PERF_AUDIT_REGRESSION.json"; then
              attempt_rc=0
            else
              attempt_rc=$?
            fi

            if [[ -f "${attempt_dir}/STRICT_GATE_RECENT_PERF_AUDIT_REGRESSION.md" ]]; then
              cp -f "${attempt_dir}/STRICT_GATE_RECENT_PERF_AUDIT_REGRESSION.md" "${OUTPUT_ROOT}/STRICT_GATE_RECENT_PERF_AUDIT_REGRESSION.md"
            fi
            if [[ -f "${attempt_dir}/STRICT_GATE_RECENT_PERF_AUDIT_REGRESSION.json" ]]; then
              cp -f "${attempt_dir}/STRICT_GATE_RECENT_PERF_AUDIT_REGRESSION.json" "${OUTPUT_ROOT}/STRICT_GATE_RECENT_PERF_AUDIT_REGRESSION.json"
            fi

            if [[ "${attempt_rc}" -eq 0 ]]; then
              success=1
              break
            fi
            if [[ "${attempt}" -lt "${attempts}" ]]; then
              echo "Attempt ${attempt} failed; sleep ${retry_delay_sec}s before retry..."
              sleep "${retry_delay_sec}"
            fi
          done

          if [[ "${success}" != "1" ]]; then
            echo "ERROR: strict-gate recent perf regression failed after ${attempts} attempts" >&2
            exit 1
          fi

      - name: Write regression summary to job summary
        if: always()
        run: |
          set -euo pipefail
          md="${OUTPUT_ROOT}/STRICT_GATE_RECENT_PERF_AUDIT_REGRESSION.md"
          json="${OUTPUT_ROOT}/STRICT_GATE_RECENT_PERF_AUDIT_REGRESSION.json"
          if [[ -f "${md}" ]]; then
            cat "${md}" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "strict-gate regression markdown missing: ${md}" >> "$GITHUB_STEP_SUMMARY"
          fi
          if [[ -f "${json}" ]]; then
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "JSON summary: \`${json}\`" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload strict-gate recent perf regression evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: strict-gate-recent-perf-regression
          path: |
            tmp/strict-gate-artifacts/recent-perf-regression/${{ github.run_id }}/STRICT_GATE_RECENT_PERF_AUDIT_REGRESSION.md
            tmp/strict-gate-artifacts/recent-perf-regression/${{ github.run_id }}/STRICT_GATE_RECENT_PERF_AUDIT_REGRESSION.json

      - name: Upload strict-gate recent perf regression raw outputs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: strict-gate-recent-perf-regression-raw
          path: tmp/strict-gate-artifacts/recent-perf-regression/${{ github.run_id }}
