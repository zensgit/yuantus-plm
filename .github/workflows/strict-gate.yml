name: strict-gate

on:
  workflow_dispatch:
    inputs:
      run_demo:
        description: "Run demo_plm_closed_loop step (DEMO_SCRIPT=1)"
        type: boolean
        required: false
        default: false
      run_perf_smokes:
        description: "Run optional perf-smoke steps (release-orch/esign/reports)"
        type: boolean
        required: false
        default: false
      run_recent_perf_audit:
        description: "Run helper to download recent strict-gate perf artifacts and gate optional conditions"
        type: boolean
        required: false
        default: false
      recent_perf_audit_limit:
        description: "Recent perf audit run-list limit"
        type: string
        required: false
        default: "10"
      recent_perf_max_run_age_days:
        description: "Recent perf audit run-list max age in days (run-list mode)"
        type: string
        required: false
        default: "1"
      recent_perf_conclusion:
        description: "Recent perf audit run-list conclusion filter: any|success|failure"
        type: choice
        options:
          - any
          - success
          - failure
        required: false
        default: "any"
      recent_perf_fail_if_no_runs:
        description: "Recent perf audit gate: fail when selected runs == 0"
        type: boolean
        required: false
        default: false
      recent_perf_fail_if_skipped:
        description: "Recent perf audit gate: fail when skipped downloads > 0"
        type: boolean
        required: false
        default: false
      recent_perf_fail_if_none_downloaded:
        description: "Recent perf audit gate: fail when downloaded artifacts == 0"
        type: boolean
        required: false
        default: false
      recent_perf_fail_if_no_metrics:
        description: "Recent perf audit gate: fail when selected runs have zero metrics"
        type: boolean
        required: false
        default: true
  schedule:
    # Daily 03:00 UTC (core strict gate; no perf-smokes by default)
    - cron: "0 3 * * *"
    # Weekly Monday 04:00 UTC (enable perf-smokes)
    - cron: "0 4 * * 1"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  strict_gate:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      BASE_URL: "http://127.0.0.1:7910"
      PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            pyproject.toml

      - name: Install Python deps (venv)
        run: |
          python -m venv .venv
          . .venv/bin/activate
          python -m pip install --upgrade pip
          python -m pip install -e . pytest

      - name: Install Node deps
        run: npm ci

      - name: Validate recent perf audit inputs
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.run_recent_perf_audit == 'true'
        run: |
          set -euo pipefail
          conclusion="${{ github.event.inputs.recent_perf_conclusion }}"
          limit="${{ github.event.inputs.recent_perf_audit_limit }}"
          max_age="${{ github.event.inputs.recent_perf_max_run_age_days }}"

          case "$conclusion" in
            any|success|failure) ;;
            *)
              echo "ERROR: recent_perf_conclusion must be one of any|success|failure (got: $conclusion)" >&2
              exit 2
              ;;
          esac

          if ! [[ "$limit" =~ ^[0-9]+$ ]] || [[ "$limit" -lt 1 ]]; then
            echo "ERROR: recent_perf_audit_limit must be a positive integer (got: $limit)" >&2
            exit 2
          fi
          if [[ "$limit" -gt 100 ]]; then
            echo "ERROR: recent_perf_audit_limit must be <= 100 (got: $limit)" >&2
            exit 2
          fi

          if ! [[ "$max_age" =~ ^[0-9]+$ ]]; then
            echo "ERROR: recent_perf_max_run_age_days must be a non-negative integer (got: $max_age)" >&2
            exit 2
          fi
          if [[ "$max_age" -gt 100 ]]; then
            echo "ERROR: recent_perf_max_run_age_days must be <= 100 (got: $max_age)" >&2
            exit 2
          fi

          echo "recent perf audit inputs validated: conclusion=${conclusion} limit=${limit} max_age_days=${max_age}"

      - name: Run strict gate report
        env:
          RUN_ID: STRICT_GATE_CI_${{ github.run_id }}
          OUT_DIR: tmp/strict-gate/STRICT_GATE_CI_${{ github.run_id }}
          REPORT_PATH: docs/DAILY_REPORTS/STRICT_GATE_CI_${{ github.run_id }}.md
          RUN_RUN_H_E2E: "1"
          RUN_IDENTITY_ONLY_MIGRATIONS_E2E: "1"
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.run_demo }}" == "true" ]]; then
            export DEMO_SCRIPT=1
          fi
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.run_perf_smokes }}" == "true" ]]; then
            export RUN_RELEASE_ORCH_PERF=1
            export RUN_ESIGN_PERF=1
            export RUN_REPORTS_PERF=1
          fi
          if [[ "${{ github.event_name }}" == "schedule" && "${{ github.event.schedule }}" == "0 4 * * 1" ]]; then
            export RUN_RELEASE_ORCH_PERF=1
            export RUN_ESIGN_PERF=1
            export RUN_REPORTS_PERF=1
          fi
          bash scripts/strict_gate_report.sh

      - name: Build strict gate perf summary
        if: always()
        env:
          OUT_DIR: tmp/strict-gate/STRICT_GATE_CI_${{ github.run_id }}
          PERF_SUMMARY_PATH: docs/DAILY_REPORTS/STRICT_GATE_CI_${{ github.run_id }}_PERF.md
        run: |
          set -euo pipefail
          python3 scripts/strict_gate_perf_summary.py \
            --logs-dir "${OUT_DIR}" \
            --out "${PERF_SUMMARY_PATH}"
          if [[ -f "${PERF_SUMMARY_PATH}" ]]; then
            cat "${PERF_SUMMARY_PATH}" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Build strict gate perf trend
        if: always()
        env:
          PERF_TREND_PATH: docs/DAILY_REPORTS/STRICT_GATE_CI_${{ github.run_id }}_PERF_TREND.md
        run: |
          set -euo pipefail
          python3 scripts/strict_gate_perf_trend.py \
            --dir docs/DAILY_REPORTS \
            --glob 'STRICT_GATE_*_PERF.md' \
            --out "${PERF_TREND_PATH}" \
            --limit 30 \
            --include-empty
          if [[ -f "${PERF_TREND_PATH}" ]]; then
            cat "${PERF_TREND_PATH}" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Optional recent perf audit (download + trend)
        if: always() && github.event_name == 'workflow_dispatch' && github.event.inputs.run_recent_perf_audit == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          AUDIT_DIR: tmp/strict-gate-artifacts/recent-perf-audit/${{ github.run_id }}
        run: |
          set -euo pipefail
          args=(
            --workflow strict-gate
            --branch "${{ github.ref_name }}"
            --conclusion "${{ github.event.inputs.recent_perf_conclusion }}"
            --limit "${{ github.event.inputs.recent_perf_audit_limit }}"
            --max-run-age-days "${{ github.event.inputs.recent_perf_max_run_age_days }}"
            --artifact-name strict-gate-perf-summary
            --download-dir "${AUDIT_DIR}"
            --trend-out "${AUDIT_DIR}/STRICT_GATE_PERF_TREND.md"
            --json-out "${AUDIT_DIR}/strict_gate_perf_download.json"
            --include-empty
          )
          if [[ "${{ github.event.inputs.recent_perf_fail_if_no_runs }}" == "true" ]]; then
            args+=(--fail-if-no-runs)
          fi
          if [[ "${{ github.event.inputs.recent_perf_fail_if_skipped }}" == "true" ]]; then
            args+=(--fail-if-skipped)
          fi
          if [[ "${{ github.event.inputs.recent_perf_fail_if_none_downloaded }}" == "true" ]]; then
            args+=(--fail-if-none-downloaded)
          fi
          if [[ "${{ github.event.inputs.recent_perf_fail_if_no_metrics }}" == "true" ]]; then
            args+=(--fail-if-no-metrics)
          fi
          bash scripts/strict_gate_perf_download_and_trend.sh "${args[@]}"
          if [[ -f "${AUDIT_DIR}/STRICT_GATE_PERF_TREND.md" ]]; then
            {
              echo ""
              echo "## Recent Perf Audit Trend"
              cat "${AUDIT_DIR}/STRICT_GATE_PERF_TREND.md"
            } >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Download artifacts hints
        if: always()
        run: |
          set -euo pipefail
          MODE_DEMO="false"
          MODE_PERF="false"
          MODE_RECENT_PERF_AUDIT="false"
          MODE_REASON="default"
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            MODE_DEMO="${{ github.event.inputs.run_demo }}"
            MODE_PERF="${{ github.event.inputs.run_perf_smokes }}"
            MODE_RECENT_PERF_AUDIT="${{ github.event.inputs.run_recent_perf_audit }}"
            MODE_REASON="workflow_dispatch"
          fi
          if [[ "${{ github.event_name }}" == "schedule" && "${{ github.event.schedule }}" == "0 4 * * 1" ]]; then
            MODE_PERF="true"
            MODE_REASON="weekly_schedule_perf"
          fi
          {
            echo "## Strict Gate Artifacts"
            echo ""
            echo "Run ID: \`${{ github.run_id }}\`"
            echo "Trigger: \`${{ github.event_name }}\`"
            echo "Mode: demo=\`${MODE_DEMO}\`, perf_smokes=\`${MODE_PERF}\`, recent_perf_audit=\`${MODE_RECENT_PERF_AUDIT}\` (\`${MODE_REASON}\`)"
            echo ""
            echo '```bash'
            echo "RUN_ID=${{ github.run_id }}"
            echo 'OUT_DIR=tmp/strict-gate-artifacts/$RUN_ID'
            echo 'mkdir -p "$OUT_DIR"'
            echo 'gh run download "$RUN_ID" -n strict-gate-report -D "$OUT_DIR"'
            echo 'gh run download "$RUN_ID" -n strict-gate-perf-summary -D "$OUT_DIR"'
            echo 'gh run download "$RUN_ID" -n strict-gate-perf-trend -D "$OUT_DIR"'
            echo 'gh run download "$RUN_ID" -n strict-gate-logs   -D "$OUT_DIR"'
            echo 'gh run download "$RUN_ID" -n strict-gate-recent-perf-audit -D "$OUT_DIR"'
            echo '```'
            echo ""
            echo "Report path (inside artifact): \`docs/DAILY_REPORTS/STRICT_GATE_CI_${{ github.run_id }}.md\`"
            echo "Perf summary path (inside artifact): \`docs/DAILY_REPORTS/STRICT_GATE_CI_${{ github.run_id }}_PERF.md\`"
            echo "Perf trend path (inside artifact): \`docs/DAILY_REPORTS/STRICT_GATE_CI_${{ github.run_id }}_PERF_TREND.md\`"
            echo "Logs dir (inside artifact): \`tmp/strict-gate/STRICT_GATE_CI_${{ github.run_id }}\`"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Write report to job summary
        if: always()
        env:
          REPORT_PATH: docs/DAILY_REPORTS/STRICT_GATE_CI_${{ github.run_id }}.md
        run: |
          if [[ -f "${REPORT_PATH}" ]]; then
            cat "${REPORT_PATH}" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "strict gate report missing: ${REPORT_PATH}" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload strict gate report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: strict-gate-report
          path: docs/DAILY_REPORTS/STRICT_GATE_CI_${{ github.run_id }}.md

      - name: Upload strict gate perf summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: strict-gate-perf-summary
          path: docs/DAILY_REPORTS/STRICT_GATE_CI_${{ github.run_id }}_PERF.md

      - name: Upload strict gate perf trend
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: strict-gate-perf-trend
          path: docs/DAILY_REPORTS/STRICT_GATE_CI_${{ github.run_id }}_PERF_TREND.md

      - name: Upload strict gate logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: strict-gate-logs
          path: tmp/strict-gate/STRICT_GATE_CI_${{ github.run_id }}

      - name: Upload strict gate recent perf audit
        if: always() && github.event_name == 'workflow_dispatch' && github.event.inputs.run_recent_perf_audit == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: strict-gate-recent-perf-audit
          path: tmp/strict-gate-artifacts/recent-perf-audit/${{ github.run_id }}
