# YuantusPLM Docker Compose
# Private Deployment: PostgreSQL + MinIO + API + Worker

services:
  # =============================================================================
  # Infrastructure Services
  # =============================================================================
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: yuantus
      POSTGRES_USER: yuantus
      POSTGRES_PASSWORD: yuantus
    ports:
      # Avoid conflict with an existing Postgres on the host.
      - "55432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./deployments/docker/postgres-init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U yuantus"]
      interval: 5s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    # NOTE: Do not bind 6379 on host by default to avoid conflicts with an existing Redis.
    # If you need host access, add an override (e.g. 6380:6379).

  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      # Avoid conflict with an existing MinIO on the host.
      # Container ports remain 9000/9001; host ports are 59000/59001 by default.
      - "59000:9000"
      - "59001:9001"
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      default:
        aliases:
          - yuantus-minio

  # =============================================================================
  # Application Services
  # =============================================================================
  api:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PIP_INDEX_URL: ${PIP_INDEX_URL:-}
        PIP_TRUSTED_HOST: ${PIP_TRUSTED_HOST:-}
    ports:
      - "7910:7910"
    environment:
      # Database (use postgres service name within docker network)
      YUANTUS_DATABASE_URL: postgresql+psycopg://yuantus:yuantus@postgres:5432/yuantus
      # Schema mode: use migrations for production
      YUANTUS_SCHEMA_MODE: migrations
      # Tenancy (optional)
      YUANTUS_TENANCY_MODE: ${YUANTUS_TENANCY_MODE:-single}
      YUANTUS_DATABASE_URL_TEMPLATE: ${YUANTUS_DATABASE_URL_TEMPLATE:-}
      YUANTUS_IDENTITY_DATABASE_URL: ${YUANTUS_IDENTITY_DATABASE_URL:-postgresql+psycopg://yuantus:yuantus@postgres:5432/yuantus_identity}
      YUANTUS_PLATFORM_ADMIN_ENABLED: ${YUANTUS_PLATFORM_ADMIN_ENABLED:-false}
      YUANTUS_PLATFORM_TENANT_ID: ${YUANTUS_PLATFORM_TENANT_ID:-platform}
      # Storage: S3/MinIO
      YUANTUS_STORAGE_TYPE: s3
      # Internal endpoint (container-to-container)
      YUANTUS_S3_ENDPOINT_URL: http://yuantus-minio:9000
      # Public endpoint (used in presigned URLs; must be reachable by clients on the host)
      YUANTUS_S3_PUBLIC_ENDPOINT_URL: http://localhost:59000
      YUANTUS_S3_BUCKET_NAME: yuantus
      YUANTUS_S3_ACCESS_KEY_ID: minioadmin
      YUANTUS_S3_SECRET_ACCESS_KEY: minioadmin
      # Auth
      YUANTUS_AUTH_MODE: required
      YUANTUS_JWT_SECRET_KEY: change-me-in-production
      # Audit logs
      YUANTUS_AUDIT_ENABLED: ${YUANTUS_AUDIT_ENABLED:-false}
      YUANTUS_AUDIT_RETENTION_DAYS: ${YUANTUS_AUDIT_RETENTION_DAYS:-0}
      YUANTUS_AUDIT_RETENTION_MAX_ROWS: ${YUANTUS_AUDIT_RETENTION_MAX_ROWS:-0}
      YUANTUS_AUDIT_RETENTION_PRUNE_INTERVAL_SECONDS: ${YUANTUS_AUDIT_RETENTION_PRUNE_INTERVAL_SECONDS:-600}
      # Quotas
      YUANTUS_QUOTA_MODE: ${YUANTUS_QUOTA_MODE:-disabled}
      # Athena (optional)
      YUANTUS_ATHENA_BASE_URL: ${YUANTUS_ATHENA_BASE_URL:-}
      YUANTUS_ATHENA_SERVICE_TOKEN: ${YUANTUS_ATHENA_SERVICE_TOKEN:-}
      YUANTUS_ATHENA_TOKEN_URL: ${YUANTUS_ATHENA_TOKEN_URL:-}
      YUANTUS_ATHENA_CLIENT_ID: ${YUANTUS_ATHENA_CLIENT_ID:-}
      YUANTUS_ATHENA_CLIENT_SECRET: ${YUANTUS_ATHENA_CLIENT_SECRET:-}
      YUANTUS_ATHENA_CLIENT_SECRET_FILE: ${YUANTUS_ATHENA_CLIENT_SECRET_FILE:-}
      YUANTUS_ATHENA_CLIENT_SCOPE: ${YUANTUS_ATHENA_CLIENT_SCOPE:-}
      # CAD extractor + connector config (optional)
      YUANTUS_CAD_EXTRACTOR_BASE_URL: ${YUANTUS_CAD_EXTRACTOR_BASE_URL:-http://cad-extractor:8200}
      YUANTUS_CAD_EXTRACTOR_SERVICE_TOKEN: ${YUANTUS_CAD_EXTRACTOR_SERVICE_TOKEN:-}
      YUANTUS_CAD_EXTRACTOR_TIMEOUT_SECONDS: ${YUANTUS_CAD_EXTRACTOR_TIMEOUT_SECONDS:-30}
      YUANTUS_CAD_EXTRACTOR_MODE: ${YUANTUS_CAD_EXTRACTOR_MODE:-required}
      YUANTUS_CAD_CONNECTOR_BASE_URL: ${YUANTUS_CAD_CONNECTOR_BASE_URL:-http://cad-connector:8300}
      YUANTUS_CAD_CONNECTOR_SERVICE_TOKEN: ${YUANTUS_CAD_CONNECTOR_SERVICE_TOKEN:-}
      YUANTUS_CAD_CONNECTOR_TIMEOUT_SECONDS: ${YUANTUS_CAD_CONNECTOR_TIMEOUT_SECONDS:-60}
      YUANTUS_CAD_CONNECTOR_MODE: ${YUANTUS_CAD_CONNECTOR_MODE:-optional}
      YUANTUS_CADGF_ROUTER_BASE_URL: ${YUANTUS_CADGF_ROUTER_BASE_URL:-}
      YUANTUS_CADGF_ROUTER_PUBLIC_BASE_URL: ${YUANTUS_CADGF_ROUTER_PUBLIC_BASE_URL:-}
      YUANTUS_CAD_CONNECTORS_CONFIG_PATH: ${YUANTUS_CAD_CONNECTORS_CONFIG_PATH:-}
      YUANTUS_DEDUP_VISION_BASE_URL: ${YUANTUS_DEDUP_VISION_BASE_URL:-http://dedup-vision:8000}
      YUANTUS_CAD_CONNECTORS_ALLOW_PATH_OVERRIDE: ${YUANTUS_CAD_CONNECTORS_ALLOW_PATH_OVERRIDE:-false}
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://127.0.0.1:7910/api/v1/health').read()",
        ]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    # Run migrations and init storage before starting
    command: >
      sh -c "
        echo 'Waiting for database...' &&
        sleep 2 &&
          echo 'Running migrations...' &&
          yuantus db upgrade &&
          if [ -n \"$$YUANTUS_IDENTITY_DATABASE_URL\" ]; then
            echo 'Running identity migrations...' &&
            yuantus db upgrade --identity
          else
            echo 'Skipping identity migrations (empty IDENTITY_DATABASE_URL)'
          fi &&
        echo 'Initializing storage...' &&
        yuantus init-storage &&
        echo 'Starting API server...' &&
        yuantus start
      "

  worker:
    build:
      context: .
      dockerfile: Dockerfile.worker
      args:
        PIP_INDEX_URL: ${PIP_INDEX_URL:-}
        PIP_TRUSTED_HOST: ${PIP_TRUSTED_HOST:-}
    environment:
      YUANTUS_DATABASE_URL: postgresql+psycopg://yuantus:yuantus@postgres:5432/yuantus
      YUANTUS_SCHEMA_MODE: migrations
      YUANTUS_TENANCY_MODE: ${YUANTUS_TENANCY_MODE:-single}
      YUANTUS_DATABASE_URL_TEMPLATE: ${YUANTUS_DATABASE_URL_TEMPLATE:-}
      YUANTUS_IDENTITY_DATABASE_URL: ${YUANTUS_IDENTITY_DATABASE_URL:-postgresql+psycopg://yuantus:yuantus@postgres:5432/yuantus_identity}
      YUANTUS_PLATFORM_ADMIN_ENABLED: ${YUANTUS_PLATFORM_ADMIN_ENABLED:-false}
      YUANTUS_PLATFORM_TENANT_ID: ${YUANTUS_PLATFORM_TENANT_ID:-platform}
      YUANTUS_STORAGE_TYPE: s3
      YUANTUS_S3_ENDPOINT_URL: http://yuantus-minio:9000
      YUANTUS_S3_PUBLIC_ENDPOINT_URL: http://localhost:59000
      YUANTUS_S3_BUCKET_NAME: yuantus
      YUANTUS_S3_ACCESS_KEY_ID: minioadmin
      YUANTUS_S3_SECRET_ACCESS_KEY: minioadmin
      YUANTUS_QUOTA_MODE: ${YUANTUS_QUOTA_MODE:-disabled}
      YUANTUS_ATHENA_BASE_URL: ${YUANTUS_ATHENA_BASE_URL:-}
      YUANTUS_ATHENA_SERVICE_TOKEN: ${YUANTUS_ATHENA_SERVICE_TOKEN:-}
      YUANTUS_ATHENA_TOKEN_URL: ${YUANTUS_ATHENA_TOKEN_URL:-}
      YUANTUS_ATHENA_CLIENT_ID: ${YUANTUS_ATHENA_CLIENT_ID:-}
      YUANTUS_ATHENA_CLIENT_SECRET: ${YUANTUS_ATHENA_CLIENT_SECRET:-}
      YUANTUS_ATHENA_CLIENT_SECRET_FILE: ${YUANTUS_ATHENA_CLIENT_SECRET_FILE:-}
      YUANTUS_ATHENA_CLIENT_SCOPE: ${YUANTUS_ATHENA_CLIENT_SCOPE:-}
      YUANTUS_CAD_EXTRACTOR_BASE_URL: ${YUANTUS_CAD_EXTRACTOR_BASE_URL:-http://cad-extractor:8200}
      YUANTUS_CAD_EXTRACTOR_SERVICE_TOKEN: ${YUANTUS_CAD_EXTRACTOR_SERVICE_TOKEN:-}
      YUANTUS_CAD_EXTRACTOR_TIMEOUT_SECONDS: ${YUANTUS_CAD_EXTRACTOR_TIMEOUT_SECONDS:-30}
      YUANTUS_CAD_EXTRACTOR_MODE: ${YUANTUS_CAD_EXTRACTOR_MODE:-required}
      YUANTUS_CAD_CONNECTOR_BASE_URL: ${YUANTUS_CAD_CONNECTOR_BASE_URL:-http://cad-connector:8300}
      YUANTUS_CAD_CONNECTOR_SERVICE_TOKEN: ${YUANTUS_CAD_CONNECTOR_SERVICE_TOKEN:-}
      YUANTUS_CAD_CONNECTOR_TIMEOUT_SECONDS: ${YUANTUS_CAD_CONNECTOR_TIMEOUT_SECONDS:-60}
      YUANTUS_CAD_CONNECTOR_MODE: ${YUANTUS_CAD_CONNECTOR_MODE:-optional}
      YUANTUS_CADGF_ROUTER_BASE_URL: ${YUANTUS_CADGF_ROUTER_BASE_URL:-}
      YUANTUS_CADGF_ROUTER_PUBLIC_BASE_URL: ${YUANTUS_CADGF_ROUTER_PUBLIC_BASE_URL:-}
      YUANTUS_CAD_CONNECTORS_CONFIG_PATH: ${YUANTUS_CAD_CONNECTORS_CONFIG_PATH:-}
      # Dedup Vision (required for cad_dedup_vision jobs)
      YUANTUS_DEDUP_VISION_BASE_URL: ${YUANTUS_DEDUP_VISION_BASE_URL:-http://dedup-vision:8000}
    command:
      [
        "yuantus",
        "worker",
        "--poll-interval",
        "5",
        "--tenant",
        "${YUANTUS_WORKER_TENANT_ID:-tenant-1}",
        "--org",
        "${YUANTUS_WORKER_ORG_ID:-org-1}",
      ]
    depends_on:
      api:
        condition: service_healthy

  # =============================================================================
  # DedupCAD Vision (2D similarity search)
  # =============================================================================
  dedup-vision:
    # This service is built from an external repo by default. Keep it opt-in so
    # CI and basic local compose runs don't fail when the build context isn't present.
    profiles: ["dedup"]
    build:
      context: ${DEDUP_VISION_BUILD_CONTEXT:-../dedupcad-vision}
      dockerfile: Dockerfile
    ports:
      - "${DEDUP_VISION_PORT:-8100}:8000"
    environment:
      CADDEDUP_VISION_PORT: "8000"
      S3_ENABLED: "false"
      EVENT_BUS_ENABLED: "false"
      INTEGRATION_AUTH_MODE: "disabled"
      LOG_LEVEL: "INFO"
    volumes:
      - dedup_vision_data:/app/data
      - dedup_vision_indexes:/app/indexes
      - dedup_vision_logs:/app/logs

  # =============================================================================
  # Optional CAD Extractor Microservice
  # =============================================================================
  cad-extractor:
    build:
      context: ./services/cad-extractor
      dockerfile: Dockerfile
    ports:
      - "${YUANTUS_CAD_EXTRACTOR_PORT:-8200}:8200"
    environment:
      CAD_EXTRACTOR_AUTH_MODE: ${CAD_EXTRACTOR_AUTH_MODE:-disabled}
      CAD_EXTRACTOR_SERVICE_TOKEN: ${CAD_EXTRACTOR_SERVICE_TOKEN:-}
      CAD_EXTRACTOR_MAX_UPLOAD_MB: ${CAD_EXTRACTOR_MAX_UPLOAD_MB:-200}
      CAD_EXTRACTOR_HASH_ALG: ${CAD_EXTRACTOR_HASH_ALG:-}
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8200/health').read()",
        ]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s
    restart: unless-stopped

volumes:
  postgres_data:
  minio_data:
  dedup_vision_data:
  dedup_vision_indexes:
  dedup_vision_logs:
